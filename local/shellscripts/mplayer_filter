#!/usr/bin/env perl
use strict;
use warnings;

sub star {
  my $star = shift;

  for (my $i = 0; $i < $star; $i++) {
    print "X";
  }
}

while (my $line = readline(*STDIN)) {
  chomp $line;
  if ($line =~ /^Playing (.*)\.$/) {
    my $star = `movie_db get star $1`;
    chomp $star;
    print "Now Playing: $1, ";
    star($star);
    print "\n";
  } elsif ($line =~ /^.*ANS_path=(.*)/) {
    my $star = `movie_db get star $1`;
    chomp $star;
    $star++;
    if ($star <= 5) {
      my $referer = `movie_db get referer $1`;
      chomp($referer);
      print "-----\n";
      print "Add star: ";
      star($star);
      print "\n";
      if ($referer eq "") {
        system("movie_db set star $star $1");
        print "$1\n";
      } else {
        my $matches = `movie_db match referer $referer`;
        foreach my $file (split("\n", $matches)) {
          system("movie_db set star $star $file");
          print "$file\n";
        }
      }
      print "-----\n";
    }
  }
}
