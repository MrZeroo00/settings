#!/usr/bin/env perl
use strict;
use warnings;

sub star {
  my $star = shift;

  return "X" x $star;
}

while (my $line = readline(*STDIN)) {
  chomp $line;
  if ($line =~ /^Playing (.*)\.$/) {
    my $star = `movie_db get star $1`;
    chomp $star;

    my $count = `movie_db get count $1`;
    chomp $count;
    $count++;
    system("movie_db set count $count $1");

    printf "Now Playing: %s, %s, %d\n", $1, star($star), $count;
  } elsif ($line =~ /^.*ANS_path=(.*)/) {
    my $star = `movie_db get star $1`;
    chomp $star;
    $star++;
    if ($star <= 5) {
      my $referer = `movie_db get referer $1`;
      chomp($referer);
      print "-----\n";
      printf "Add star: %s\n", star($star);
      if ($referer eq "") {
        system("movie_db set star $star $1");
        print "$1\n";
      } else {
        my $matches = `movie_db match referer $referer`;
        foreach my $file (split("\n", $matches)) {
          system("movie_db set star $star $file");
          print "$file\n";
        }
      }
      print "-----\n";
    }
  }
}
