## setenv (csh compatibility)
setenv() {
  typeset -x "${1}${1:+=}${(@)argv[2,$#]}"
}


## freload
freload() {
  while (( $# )); do;
    unfunction $1;
    autoload -U $1;
    shift;
  done
}


## dabbrev
# http://d.hatena.ne.jp/secondlife/20060108/1136650653
HARDCOPYFILE=$HOME/tmp/screen-hardcopy
touch $HARDCOPYFILE

dabbrev-complete () {
  local reply lines=80 # 80è¡Œåˆ†
  screen -X eval "hardcopy -h $HARDCOPYFILE"
  reply=($(sed '/^$/d' $HARDCOPYFILE | sed '$ d' | tail -$lines))
  compadd - "${reply[@]%[*/=@|]}"
}

zle -C dabbrev-complete menu-complete dabbrev-complete
bindkey '^o' dabbrev-complete
bindkey '^o^_' reverse-menu-complete


## cdd
# http://d.hatena.ne.jp/secondlife/20080218/1203303528
autoload -U compinit
compinit
source $HOME/bin/cdd

function chpwd() {
  _reg_pwd_screennum
}


## ssh_screen
function ssh_screen() {
  eval server=\${$#}
    screen -t $server ssh "$@"
}
if [ x$TERM = x$TERMSCREEN ]; then
  alias ssh=ssh_screen
fi


# for screen status line
if [ "$TERM" = $TERMSCREEN ]; then
  chpwd () { echo -n "_`dirs`\\" }
  preexec() {
    # see [zsh-workers:13180]
    # http://www.zsh.org/mla/workers/2000/msg03993.html
    emulate -L zsh
    local -a cmd; cmd=(${(z)2})
    case $cmd[1] in
      fg)
      if (( $#cmd == 1 )); then
        cmd=(builtin jobs -l %+)
      else
        cmd=(builtin jobs -l $cmd[2])
      fi
      ;;
      %*)
      cmd=(builtin jobs -l $cmd[1])
      ;;
      cd)
      if (( $#cmd == 2)); then
        cmd[1]=$cmd[2]
      fi
      ;;
      *)
      echo -n "k$cmd[1]:t\\"
      prev=$cmd[1]
      return
      ;;
    esac

    local -A jt; jt=(${(kv)jobtexts})

    $cmd >>(read num rest
    cmd=(${(z)${(e):-\$jt$num}})
    echo -n "k$cmd[1]:t\\") 2>/dev/null

    prev=$cmd[1]
  }
  precmd() {
    #local prev; prev=`history -1 | sed "s/^[ 0-9]*//" | sed "s/ .*$//"`
    echo -n "k$:$prev\\"
  }
  chpwd
fi
